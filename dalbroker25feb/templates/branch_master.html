{% extends 'base.html' %}
{% block title %}Branch Master{% endblock %}

{% block content %}
<div class="page-header">
  <nav class="breadcrumb-custom" aria-label="breadcrumb">
    <a href="/dashboard/">Dashboard</a>
    <i class="separator fa fa-chevron-right"></i>
    <a href="#">Branches</a>
    <i class="separator fa fa-chevron-right"></i>
    <span class="active">Branch Master</span>
  </nav>

  <div class="d-flex justify-content-between align-items-center">
    <h1 class="page-title">Branch Master</h1>
    <button type="button" class="btn btn-dal" id="openCreateBranchModal">
      <i class="fas fa-plus"></i> Add Location
    </button>
  </div>
</div>

<div id="branchAlertBox"></div>

<div class="table-responsive card">
  <table class="table table-custom" id="branchTable">
    <thead>
      <tr>
        <th>Location Name</th>
        <th>State</th>
        <th>City</th>
        <th>Area</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="branchTableBody">
      {% for branch in branches %}
      <tr id="branch-row-{{ branch.id }}">
        <td>{{ branch.location_name }}</td>
        <td>{{ branch.state }}</td>
        <td>{{ branch.city }}</td>
        <td>{{ branch.area }}</td>
        <td>
          {% if branch.is_active %}
          <span class="badge bg-success">Active</span>
          {% else %}
          <span class="badge bg-secondary">Inactive</span>
          {% endif %}
        </td>
        <td>
          <div class="d-flex gap-2">
            <div class="form-check form-switch mt-1">
              <input class="form-check-input branch-status-toggle" type="checkbox"
                data-id="{{ branch.id }}"
                {% if branch.is_active %}checked{% endif %}
                title="Toggle Active/Inactive">
            </div>
            <button type="button" class="btn-action btn-edit edit-branch"
              data-id="{{ branch.id }}"
              data-location-name="{{ branch.location_name }}"
              data-state="{{ branch.state }}"
              data-city="{{ branch.city }}"
              data-area="{{ branch.area }}"
              data-is-active="{{ branch.is_active|yesno:'true,false' }}">
              <i class="fas fa-edit"></i>
            </button>
            <button type="button" class="btn-action btn-delete delete-branch"
              data-id="{{ branch.id }}"
              data-location-name="{{ branch.location_name }}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
      {% empty %}
      <tr id="empty-branches-row">
        <td colspan="6" class="text-center text-muted">No branches found. Click "Add Location" to create one.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="modal fade" id="branchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="branchModalLabel">Add Location</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="branchForm">
          {% csrf_token %}
          <input type="hidden" id="branch_id">
          <div class="mb-3">
            <label class="form-label">Location Name *</label>
            <input type="text" class="form-control" id="location_name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">State *</label>
            <select class="form-select" id="state_select" required>
              <option value="">Select State</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">City *</label>
            <select class="form-select" id="city_select" disabled required>
              <option value="">Select City</option>
            </select>
          </div>
          <div class="mb-0">
            <label class="form-label">Area *</label>
            <select class="form-select" id="area_select" disabled required>
              <option value="">Select Area</option>
            </select>
          </div>
          <div class="mt-2 d-none" id="manualAreaWrap">
            <label class="form-label">Manual Area *</label>
            <input type="text" class="form-control" id="manual_area" placeholder="Enter area manually">
          </div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="manual_area_toggle">
            <label class="form-check-label" for="manual_area_toggle">Area not listed? Enter manually</label>
          </div>
          <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" role="switch" id="branch_is_active" checked>
            <label class="form-check-label" for="branch_is_active">Active</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <div class="me-auto d-none" id="branchLoader">
          <span class="spinner-border spinner-border-sm text-primary"></span>
          <span class="small text-muted ms-1">Loading...</span>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveBranchBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteBranchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Delete Branch</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this branch?</p>
        <strong id="deleteBranchName"></strong>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBranchBtn">Delete</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const branchModal = new bootstrap.Modal(document.getElementById('branchModal'));
const deleteBranchModal = new bootstrap.Modal(document.getElementById('deleteBranchModal'));
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
let deletingBranchId = null;

const stateSelect = document.getElementById('state_select');
const citySelect = document.getElementById('city_select');
const areaSelect = document.getElementById('area_select');
const manualAreaWrap = document.getElementById('manualAreaWrap');
const manualAreaInput = document.getElementById('manual_area');
const manualAreaToggle = document.getElementById('manual_area_toggle');
const stateCache = { list: null };
const cityCache = new Map();
const areaCache = new Map();

function showBranchAlert(type, message) {
  document.getElementById('branchAlertBox').innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;
}

function setLoader(show) {
  document.getElementById('branchLoader').classList.toggle('d-none', !show);
}

async function fetchJson(url) {
  const res = await fetch(url);
  const data = await res.json();
  if (!res.ok || !data.success) {
    throw new Error(data.message || 'Request failed.');
  }
  return data;
}

function resetSelect(selectElement, placeholder, disabled) {
  selectElement.innerHTML = `<option value="">${placeholder}</option>`;
  selectElement.disabled = !!disabled;
}

function fillSelect(selectElement, options, placeholder) {
  resetSelect(selectElement, placeholder, false);
  options.forEach(item => {
    const opt = document.createElement('option');
    opt.value = item;
    opt.textContent = item;
    selectElement.appendChild(opt);
  });
}

function toggleManualAreaMode(enable) {
  manualAreaWrap.classList.toggle('d-none', !enable);
  areaSelect.disabled = !!enable;
  if (enable) {
    areaSelect.value = '';
  } else {
    manualAreaInput.value = '';
    if (!stateSelect.value || !citySelect.value) {
      areaSelect.disabled = true;
    }
  }
}

function branchRowHtml(branch) {
  const active = !!branch.is_active;
  return `
    <td>${branch.location_name}</td>
    <td>${branch.state}</td>
    <td>${branch.city}</td>
    <td>${branch.area}</td>
    <td>${active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</td>
    <td>
      <div class="d-flex gap-2">
        <div class="form-check form-switch mt-1">
          <input class="form-check-input branch-status-toggle" type="checkbox"
            data-id="${branch.id}"
            ${active ? 'checked' : ''}
            title="Toggle Active/Inactive">
        </div>
        <button type="button" class="btn-action btn-edit edit-branch"
          data-id="${branch.id}"
          data-location-name="${branch.location_name}"
          data-state="${branch.state}"
          data-city="${branch.city}"
          data-area="${branch.area}"
          data-is-active="${active ? 'true' : 'false'}">
          <i class="fas fa-edit"></i>
        </button>
        <button type="button" class="btn-action btn-delete delete-branch"
          data-id="${branch.id}"
          data-location-name="${branch.location_name}">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </td>
  `;
}

function upsertBranchRow(branch) {
  const tableBody = document.getElementById('branchTableBody');
  const existingRow = document.getElementById(`branch-row-${branch.id}`);
  if (existingRow) {
    existingRow.innerHTML = branchRowHtml(branch);
    return;
  }
  const emptyRow = document.getElementById('empty-branches-row');
  if (emptyRow) emptyRow.remove();
  const row = document.createElement('tr');
  row.id = `branch-row-${branch.id}`;
  row.innerHTML = branchRowHtml(branch);
  tableBody.prepend(row);
}

async function loadStates(preselect='') {
  if (stateCache.list) {
    fillSelect(stateSelect, stateCache.list, 'Select State');
    if (preselect) stateSelect.value = preselect;
    return;
  }
  setLoader(true);
  try {
    const data = await fetchJson('/api/location/states/');
    stateCache.list = data.states || [];
    fillSelect(stateSelect, stateCache.list, 'Select State');
  } catch (error) {
    showBranchAlert('danger', error.message || 'Unable to load states.');
    return;
  } finally {
    setLoader(false);
  }
  if (preselect) stateSelect.value = preselect;
}

async function loadCities(state, preselect='') {
  resetSelect(citySelect, 'Select City', true);
  resetSelect(areaSelect, 'Select Area', true);
  manualAreaToggle.checked = false;
  toggleManualAreaMode(false);
  if (!state) return;

  const cacheKey = state.trim().toLowerCase();
  if (cityCache.has(cacheKey)) {
    fillSelect(citySelect, cityCache.get(cacheKey), 'Select City');
    if (preselect) citySelect.value = preselect;
    return;
  }

  setLoader(true);
  try {
    const data = await fetchJson(`/api/location/cities/?state=${encodeURIComponent(state)}`);
    const cities = data.cities || [];
    cityCache.set(cacheKey, cities);
    fillSelect(citySelect, cities, 'Select City');
  } catch (error) {
    showBranchAlert('danger', error.message || 'Unable to load cities.');
    return;
  } finally {
    setLoader(false);
  }
  if (preselect) citySelect.value = preselect;
}

async function loadAreas(state, city, preselect='') {
  resetSelect(areaSelect, 'Select Area', true);
  if (!state || !city) return;

  const cacheKey = `${state.trim().toLowerCase()}|${city.trim().toLowerCase()}`;
  if (areaCache.has(cacheKey)) {
    const areas = areaCache.get(cacheKey);
    if (!areas.length) {
      resetSelect(areaSelect, 'No areas found', true);
      manualAreaToggle.checked = true;
      toggleManualAreaMode(true);
      if (preselect) manualAreaInput.value = preselect;
      return;
    }
    manualAreaToggle.checked = false;
    toggleManualAreaMode(false);
    fillSelect(areaSelect, areas, 'Select Area');
    if (preselect) areaSelect.value = preselect;
    return;
  }

  setLoader(true);
  try {
    const data = await fetchJson(`/api/location/areas/?state=${encodeURIComponent(state)}&city=${encodeURIComponent(city)}`);
    const areas = data.areas || [];
    areaCache.set(cacheKey, areas);
    if (!areas.length) {
      resetSelect(areaSelect, 'No areas found', true);
      manualAreaToggle.checked = true;
      toggleManualAreaMode(true);
      if (preselect) manualAreaInput.value = preselect;
      return;
    }
    manualAreaToggle.checked = false;
    toggleManualAreaMode(false);
    fillSelect(areaSelect, areas, 'Select Area');
  } catch (error) {
    showBranchAlert('danger', error.message || 'Unable to load areas.');
    return;
  } finally {
    setLoader(false);
  }
  if (preselect) areaSelect.value = preselect;
}

function openCreateModal() {
  document.getElementById('branchModalLabel').textContent = 'Add Location';
  document.getElementById('branch_id').value = '';
  document.getElementById('location_name').value = '';
  resetSelect(citySelect, 'Select City', true);
  resetSelect(areaSelect, 'Select Area', true);
  manualAreaToggle.checked = false;
  toggleManualAreaMode(false);
  document.getElementById('branch_is_active').checked = true;
  loadStates();
  branchModal.show();
}

async function openEditModal(button) {
  const id = button.dataset.id;
  const locationName = button.dataset.locationName || '';
  const state = button.dataset.state || '';
  const city = button.dataset.city || '';
  const area = button.dataset.area || '';
  const isActive = (button.dataset.isActive || 'true') === 'true';

  document.getElementById('branchModalLabel').textContent = 'Edit Location';
  document.getElementById('branch_id').value = id;
  document.getElementById('location_name').value = locationName;
  document.getElementById('branch_is_active').checked = isActive;
  manualAreaToggle.checked = false;
  toggleManualAreaMode(false);
  manualAreaInput.value = '';
  resetSelect(citySelect, 'Select City', true);
  resetSelect(areaSelect, 'Select Area', true);
  branchModal.show();

  await loadStates(state);
  await loadCities(state, city);
  await loadAreas(state, city, area);
  if (manualAreaToggle.checked && area) {
    manualAreaInput.value = area;
  }
}

async function saveBranch() {
  const branchId = document.getElementById('branch_id').value;
  const selectedArea = manualAreaToggle.checked ? manualAreaInput.value.trim() : areaSelect.value;
  const payload = {
    location_name: document.getElementById('location_name').value.trim(),
    state: stateSelect.value,
    city: citySelect.value,
    area: selectedArea,
    is_active: document.getElementById('branch_is_active').checked,
  };

  const endpoint = branchId
    ? `/api/branch/update/${branchId}/`
    : '/api/branch/create/';

  const res = await fetch(endpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken,
    },
    body: JSON.stringify(payload),
  });
  const data = await res.json();
  if (!res.ok || !data.success) {
    showBranchAlert('danger', data.message || 'Operation failed.');
    return;
  }
  upsertBranchRow(data.branch);
  branchModal.hide();
  showBranchAlert('success', data.message || 'Saved successfully.');
}

async function deleteBranch() {
  if (!deletingBranchId) return;
  const res = await fetch(`/api/branch/delete/${deletingBranchId}/`, {
    method: 'POST',
    headers: {'X-CSRFToken': csrfToken},
  });
  const data = await res.json();
  if (!res.ok || !data.success) {
    showBranchAlert('danger', data.message || 'Delete failed.');
    return;
  }
  const row = document.getElementById(`branch-row-${deletingBranchId}`);
  if (row) row.remove();
  if (!document.querySelector('#branchTableBody tr')) {
    document.getElementById('branchTableBody').innerHTML = '<tr id="empty-branches-row"><td colspan="6" class="text-center text-muted">No branches found. Click "Add Location" to create one.</td></tr>';
  }
  deleteBranchModal.hide();
  showBranchAlert('success', data.message || 'Deleted successfully.');
}

async function toggleBranchStatus(branchId, toggleEl) {
  const res = await fetch(`/api/branch/toggle/${branchId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken,
    },
    body: JSON.stringify({ is_active: toggleEl.checked }),
  });
  const data = await res.json();
  if (!res.ok || !data.success) {
    toggleEl.checked = !toggleEl.checked;
    showBranchAlert('danger', data.message || 'Unable to update status.');
    return;
  }
  upsertBranchRow(data.branch);
  showBranchAlert('success', data.message || 'Status updated.');
}

manualAreaToggle.addEventListener('change', function() {
  toggleManualAreaMode(this.checked);
});
stateSelect.addEventListener('change', () => loadCities(stateSelect.value));
citySelect.addEventListener('change', () => loadAreas(stateSelect.value, citySelect.value));
document.getElementById('openCreateBranchModal').addEventListener('click', openCreateModal);
document.getElementById('saveBranchBtn').addEventListener('click', saveBranch);
document.getElementById('confirmDeleteBranchBtn').addEventListener('click', deleteBranch);

document.addEventListener('click', (e) => {
  const editBtn = e.target.closest('.edit-branch');
  if (editBtn) {
    openEditModal(editBtn);
    return;
  }
  const deleteBtn = e.target.closest('.delete-branch');
  if (deleteBtn) {
    deletingBranchId = deleteBtn.dataset.id;
    document.getElementById('deleteBranchName').textContent = deleteBtn.dataset.locationName || '';
    deleteBranchModal.show();
  }
});

document.addEventListener('change', (e) => {
  const toggle = e.target.closest('.branch-status-toggle');
  if (!toggle) return;
  toggleBranchStatus(toggle.dataset.id, toggle);
});

// Warm states cache once, so modal opens faster later.
loadStates().catch(() => {});
</script>
{% endblock %}