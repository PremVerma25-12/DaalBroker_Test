{% extends 'base.html' %}
{% block title %}KYC Dashboard{% endblock %}
{% block content %}
<div class="container-fluid py-3">
  <style>
    .kyc-card {
      border: 1px solid #e6edf5;
      border-radius: 14px;
      box-shadow: 0 1px 8px rgba(15, 23, 42, 0.04);
      background: #ffffff;
    }
    .kyc-table th,
    .kyc-table td {
      white-space: nowrap;
    }
    .kyc-user-name {
      font-size: 16px;
      font-weight: 500;
      color: #0f172a;
      line-height: 1.2;
    }
    .kyc-user-sub {
      color: #64748b;
      font-size: 13px;
    }
    .kyc-badge {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }
    .view-row {
      border-bottom: 1px solid #eef2f7;
      padding: 8px 0;
    }
    .view-label {
      color: #64748b;
      font-size: 13px;
      font-weight: 600;
    }
    .view-value {
      color: #0f172a;
      font-size: 14px;
      word-break: break-word;
    }
    .kyc-filter-card {
      border: 1px solid #e6edf5;
      border-radius: 14px;
      padding: 12px;
      background: #ffffff;
      margin-bottom: 12px;
    }
    .btn-approve {
      background-color: var(--evt-green);
      color: var(--evt-green-text);
    }
    .btn-reject {
      background-color: #ffebee;
      color: #ef5350;
    }
  </style>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Admin KYC Dashboard</h3>
    <!-- <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">Change Password</button> -->
  </div>

  <div id="kycAlert"></div>

  <form method="get" class="kyc-filter-card">
    <div class="row g-2 align-items-center">
      <div class="col-md-4">
        <input
          type="text"
          name="search"
          class="form-control"
          placeholder="Search by name or mobile..."
          value="{{ filters.search|default:'' }}"
        >
      </div>
      <div class="col-md-3">
        <select name="role" class="form-select">
          <option value="all" {% if filters.role == 'all' %}selected{% endif %}>All Roles</option>
          {% for key, label in roles %}
          <option value="{{ key }}" {% if filters.role == key %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <select name="kyc_status" class="form-select">
          <option value="all" {% if filters.kyc_status == 'all' %}selected{% endif %}>All KYC Status</option>
          {% for key, label in kyc_status_choices %}
          <option value="{{ key }}" {% if filters.kyc_status == key %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 d-flex gap-2">
        <button type="submit" class="btn btn-primary w-100">Apply</button>
        <a href="{% url 'kyc_dashboard_page' %}" class="btn btn-outline-secondary w-100">Reset</a>
      </div>
    </div>
  </form>

  <div class="card kyc-card">
    <div class="table-responsive">
      <table class="table table-custom table-hover align-middle mb-0 kyc-table" id="kycTable">
        <thead>
          <tr id="kyc-row-{{ item.id }}">
            <th>User</th>
            <th>Mobile</th>
            <th>PAN Number</th>
            <th>Role</th>
            <th>KYC Status</th>
            <th>Submitted At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="kycTableBody">
          {% for item in kyc_users %}
          <tr>
            <td>
              <div class="kyc-user-name">
                {% if item.first_name or item.last_name %}{{ item.first_name|default:'' }} {{ item.last_name|default:'' }}{% else %}{{ item.username }}{% endif %}
              </div>
              <div class="kyc-user-sub">{{ item.username }}</div>
            </td>
            <td>{{ item.mobile|default:'-' }}</td>
            <td>{{ item.pan_number|default:'-' }}</td>
            <td>{{ item.role|default:'-' }}</td>
            <td>
              {% if item.kyc_status == 'approved' %}
                <span class="badge bg-success kyc-badge">Approved</span>
              {% elif item.kyc_status == 'rejected' %}
                <span class="badge bg-danger kyc-badge">Rejected</span>
                {% if item.kyc_rejection_reason %}
                  <div class="small text-danger mt-1">Reason: {{ item.kyc_rejection_reason }}</div>
                {% endif %}
              {% else %}
                <span class="badge bg-warning text-dark kyc-badge">Pending</span>
              {% endif %}
            </td>
            <td>{% if item.kyc_submitted_at %}{{ item.kyc_submitted_at|date:"d M Y h:i A" }}{% else %}-{% endif %}</td>
            <td>
              <div class="d-flex gap-2">
                <button class="btn-action btn-view" title="View" onclick="openViewModal({{ item.id }})">
                  <i class="fa-regular fa-eye"></i>
                </button>
                {% if item.kyc_status != 'approved' and item.kyc_status != 'rejected' %}
                <button class="btn-action btn-approve" title="Approve" onclick="approveKyc({{ item.id }})">
                  <i class="fa-solid fa-check"></i>
                </button>
                <button class="btn-action btn-reject" title="Reject" onclick="openRejectModal({{ item.id }})">
                  <i class="fa-solid fa-xmark"></i>
                </button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="text-center text-muted">No records found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% include '_pagination.html' %}
  </div>
</div>

<div class="modal fade" id="viewUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">User Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 view-row"><div class="view-label">Username</div><div id="view_username" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">Email</div><div id="view_email" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">Mobile</div><div id="view_mobile" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">Role</div><div id="view_role" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">First Name</div><div id="view_first_name" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">Last Name</div><div id="view_last_name" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">PAN Number</div><div id="view_pan_number" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">GST Number</div><div id="view_gst_number" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">Account Status</div><div id="view_account_status" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">KYC Status</div><div id="view_kyc_status" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">Submitted At</div><div id="view_kyc_submitted_at" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">Approved At</div><div id="view_kyc_approved_at" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">Rejected At</div><div id="view_kyc_rejected_at" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">Rejection Reason</div><div id="view_kyc_rejection_reason" class="view-value">-</div></div>
          <div class="col-md-6 view-row"><div class="view-label">Date Joined</div><div id="view_date_joined" class="view-value">-</div></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reject KYC</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="reject_user_id">
        <label class="form-label">Rejection Reason *</label>
        <textarea id="rejection_reason" class="form-control" rows="4" required></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmRejectBtn">Reject</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="changePassAlert"></div>
        <div class="mb-2">
          <label class="form-label">Old Password</label>
          <input type="password" id="old_password" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label">New Password</label>
          <input type="password" id="new_password" class="form-control">
        </div>
        <div>
          <label class="form-label">Confirm Password</label>
          <input type="password" id="confirm_password" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="changePasswordBtn">Update Password</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
const viewUserModal = new bootstrap.Modal(document.getElementById('viewUserModal'));

function getCsrfToken() { const m = document.cookie.match(/csrftoken=([^;]+)/); return m ? m[1] : ''; }
function authHeaders(isJson = true) {
  const token = localStorage.getItem('access');
  const headers = { 'X-CSRFToken': getCsrfToken() };
  if (isJson) headers['Content-Type'] = 'application/json';
  if (token) headers['Authorization'] = `Bearer ${token}`;
  return headers;
}

function showKycAlert(type, msg) {
  document.getElementById('kycAlert').innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
}

function showPassAlert(type, msg) {
  document.getElementById('changePassAlert').innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
}

function statusBadge(status) {
  if (status === 'approved') return '<span class="badge bg-success">Approved</span>';
  if (status === 'rejected') return '<span class="badge bg-danger">Rejected</span>';
  return '<span class="badge bg-warning text-dark">Pending</span>';
}

function loadKycTable() {
  // Kept for backward compatibility; avoid full reload for faster UX.
}

function refreshKycRow(userId) {
  authFetch(`/api/users/${userId}/`, { method: 'GET' })
    .then((res) => {
      if (!res.ok) throw new Error('Unable to refresh KYC row.');
      return res.json();
    })
    .then((u) => {
      const row = document.getElementById(`kyc-row-${userId}`);
      if (!row) return;

      const displayName = `${u.first_name || ''} ${u.last_name || ''}`.trim() || (u.username || '-');
      const reasonBlock = (u.kyc_status === 'rejected' && u.kyc_rejection_reason)
        ? `<div class="small text-danger mt-1">Reason: ${u.kyc_rejection_reason}</div>`
        : '';
      let statusHtml = '<span class="badge bg-warning text-dark kyc-badge">Pending</span>';
      if (u.kyc_status === 'approved') statusHtml = '<span class="badge bg-success kyc-badge">Approved</span>';
      if (u.kyc_status === 'rejected') statusHtml = `<span class="badge bg-danger kyc-badge">Rejected</span>${reasonBlock}`;

      row.innerHTML = `
        <td>
          <div class="kyc-user-name">${displayName}</div>
          <div class="kyc-user-sub">${u.username || '-'}</div>
        </td>
        <td>${u.mobile || '-'}</td>
        <td>${u.pan_number || '-'}</td>
        <td>${u.role || '-'}</td>
        <td>${statusHtml}</td>
        <td>${u.kyc_submitted_at || '-'}</td>
        <td>
          <div class="d-flex gap-2">
            <button class="btn-action btn-view" title="View" onclick="openViewModal(${u.id})">
              <i class="fa-regular fa-eye"></i>
            </button>
            ${u.kyc_status !== 'approved' && u.kyc_status !== 'rejected' ? `
            <button class="btn-action btn-approve" title="Approve" onclick="approveKyc(${u.id})">
              <i class="fa-solid fa-check"></i>
            </button>
            <button class="btn-action btn-reject" title="Reject" onclick="openRejectModal(${u.id})">
              <i class="fa-solid fa-xmark"></i>
            </button>
            ` : ''}
          </div>
        </td>
      `;
    })
    .catch(() => {});
}

function openViewModal(userId) {
  authFetch(`/api/users/${userId}/`, { method: 'GET' })
    .then((res) => {
      if (!res.ok) throw new Error('Failed to fetch user details.');
      return res.json();
    })
    .then((u) => {
      document.getElementById('view_username').textContent = u.username || '-';
      document.getElementById('view_email').textContent = u.email || '-';
      document.getElementById('view_mobile').textContent = u.mobile || '-';
      document.getElementById('view_role').textContent = u.role || '-';
      document.getElementById('view_first_name').textContent = u.first_name || '-';
      document.getElementById('view_last_name').textContent = u.last_name || '-';
      document.getElementById('view_pan_number').textContent = u.pan_number || '-';
      document.getElementById('view_gst_number').textContent = u.gst_number || '-';
      document.getElementById('view_account_status').textContent = u.account_status || '-';
      document.getElementById('view_kyc_status').textContent = u.kyc_status || '-';
      document.getElementById('view_kyc_submitted_at').textContent = u.kyc_submitted_at || '-';
      document.getElementById('view_kyc_approved_at').textContent = u.kyc_approved_at || '-';
      document.getElementById('view_kyc_rejected_at').textContent = u.kyc_rejected_at || '-';
      document.getElementById('view_kyc_rejection_reason').textContent = u.kyc_rejection_reason || '-';
      document.getElementById('view_date_joined').textContent = u.date_joined || '-';
      viewUserModal.show();
    })
    .catch((error) => showKycAlert('danger', error.message || 'Unable to load user details.'));
}

function approveKyc(userId) {
  authFetch(`/api/kyc/${userId}/approve/`, {
    method: 'POST',
    headers: authHeaders(true),
    body: JSON.stringify({})
  })
  .then(async (res) => {
    let data = {};
    try { data = await res.json(); } catch (e) { data = {}; }
    if (!res.ok) {
      throw new Error(data.message || data.detail || 'Approval failed.');
    }
    return data;
  })
  .then((data) => {
    if (data.message && data.message.toLowerCase().includes('success')) {
      showKycAlert('success', data.message);
      refreshKycRow(userId);
      return;
    }
    if (data.message === 'KYC approved successfully.') {
      showKycAlert('success', data.message);
      refreshKycRow(userId);
      return;
    }
    showKycAlert('danger', data.message || 'Approval failed.');
  })
  .catch((error) => showKycAlert('danger', error.message || 'Approval failed.'));
}

function openRejectModal(userId) {
  document.getElementById('reject_user_id').value = userId;
  document.getElementById('rejection_reason').value = '';
  rejectModal.show();
}

window.openRejectModal = openRejectModal;
window.approveKyc = approveKyc;
window.openViewModal = openViewModal;


document.getElementById('confirmRejectBtn').addEventListener('click', function() {
  const userId = document.getElementById('reject_user_id').value;
  const reason = document.getElementById('rejection_reason').value.trim();
  if (!reason) {
    showKycAlert('danger', 'Rejection reason is required.');
    return;
  }
  authFetch(`/api/kyc/${userId}/reject/`, {
    method: 'POST',
    headers: authHeaders(true),
    body: JSON.stringify({ rejection_reason: reason })
  })
  .then(async (res) => {
    let data = {};
    try { data = await res.json(); } catch (e) { data = {}; }
    if (!res.ok) {
      throw new Error(data.message || data.detail || 'Rejection failed.');
    }
    return data;
  })
  .then((data) => {
    if (data.message === 'KYC rejected successfully.') {
      showKycAlert('success', data.message);
      rejectModal.hide();
      refreshKycRow(userId);
      return;
    }
    showKycAlert('danger', data.message || 'Rejection failed.');
  })
  .catch((error) => showKycAlert('danger',error.message || 'Rejection failed.'));
});


document.getElementById('changePasswordBtn').addEventListener('click', function() {
  const payload = {
    old_password: document.getElementById('old_password').value,
    new_password: document.getElementById('new_password').value,
    confirm_password: document.getElementById('confirm_password').value,
  };
  fetch('/api/auth/change-password/', {
    method: 'POST',
    headers: authHeaders(true),
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if (data.message === 'Password changed successfully.') {
      showPassAlert('success', data.message);
      return;
    }
    showPassAlert('danger', data.message || JSON.stringify(data));
  })
  .catch(() => showPassAlert('danger', 'Password change failed.'));
});

</script>
{% endblock %}