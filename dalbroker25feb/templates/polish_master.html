{% extends 'base.html' %}

{% block title %}Polish Master{% endblock %}

{% block content %}


<div class="page-header">
  <!-- Breadcrumb -->
  <nav class="breadcrumb-custom" aria-label="breadcrumb">
      <a href="/dashboard/">Dashboard</a>
      <i class="separator fa fa-chevron-right"></i>
      <a href="#">Master</a>
      <i class="separator fa fa-chevron-right"></i>
      <span class="active">Polish Master</span>
  </nav>
  
  <!-- Page Title -->
  <div class="d-flex justify-content-between align-items-center">
      <h1 class="page-title">Polish Master</h1>

      <div class="d-flex gap-2">
       <button type="button" class="btn btn-dal" data-bs-toggle="modal" data-bs-target="#createPolishModal">
            <i class="fas fa-plus"></i> Add Polish
        </button>
      </div>
  </div>
</div>


                <div id="polishAlertBox"></div>
                
                <div class="table-responsive card">
                    <table class="table table-custom" id="polishTable">
                        <thead>
                            <tr>
                                <th>Polish Name</th>
                                <th>Created At</th>
                                <th>Updated At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for polish in polishes %}
                            <tr id="polish-row-{{ polish.id }}">
                                <td>{{ polish.polish_name }}</td>
                                <td>{{ polish.created_at|date:"M d, Y h:i A" }}</td>
                                <td>{{ polish.updated_at|date:"M d, Y h:i A" }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn-action btn-view view-polish" title="View" data-polish-id="{{ polish.id }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn-action btn-edit edit-polish" title="Edit" data-polish-id="{{ polish.id }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn-action btn-delete delete-polish" title="Delete" data-polish-id="{{ polish.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">No polishes found. Click "Add Polish" to create one.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
           

<!-- Create Polish Modal -->
<div class="modal fade" id="createPolishModal" tabindex="-1" aria-labelledby="createPolishModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPolishModalLabel">Add New Polish</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createPolishForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="create_polish_name" class="form-label">Polish Name *</label>
                        <input type="text" class="form-control" id="create_polish_name" name="polish_name" required>
                        <div class="invalid-feedback">Polish name is required.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCreatePolish">Create Polish</button>
            </div>
        </div>
    </div>
</div>

<!-- View Polish Modal -->
<div class="modal fade" id="viewPolishModal" tabindex="-1" aria-labelledby="viewPolishModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewPolishModalLabel">Polish Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="view_polish_details">
                    <div class="row">
                        <div class="col-md-6"><strong>Polish Name:</strong> <span id="view_polish_name"></span></div>
                        <div class="col-md-6"><strong>Created At:</strong> <span id="view_polish_created_at"></span></div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6"><strong>Updated At:</strong> <span id="view_polish_updated_at"></span></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Polish Modal -->
<div class="modal fade" id="editPolishModal" tabindex="-1" aria-labelledby="editPolishModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPolishModalLabel">Edit Polish</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPolishForm">
                    {% csrf_token %}
                    <input type="hidden" id="edit_polish_id" name="polish_id">
                    <div class="mb-3">
                        <label for="edit_polish_name" class="form-label">Polish Name *</label>
                        <input type="text" class="form-control" id="edit_polish_name" name="polish_name" required>
                        <div class="invalid-feedback">Polish name is required.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditPolish">Update Polish</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Polish Modal -->
<div class="modal fade" id="deletePolishModal" tabindex="-1" aria-labelledby="deletePolishModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deletePolishModalLabel">Delete Polish</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this polish?</p>
                <div id="deletePolishInfo">
                    <strong>Polish Name:</strong> <span id="delete_polish_name"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePolish">Delete Polish</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Polish Master JavaScript
const createPolishModal = new bootstrap.Modal(document.getElementById('createPolishModal'));
const viewPolishModal = new bootstrap.Modal(document.getElementById('viewPolishModal'));
const editPolishModal = new bootstrap.Modal(document.getElementById('editPolishModal'));
const deletePolishModal = new bootstrap.Modal(document.getElementById('deletePolishModal'));
let deletePolishId = null;

// ===================== POLISH ALERT =====================
function showPolishAlert(type, msg){
    document.getElementById("polishAlertBox").innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show">
            ${msg}
            <button class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
}

// ===================== EVENT DELEGATION =====================
document.addEventListener("click", function(e){

    // -------- VIEW POLISH --------
    if(e.target.classList.contains("view-polish") || e.target.closest(".view-polish")){
        const button = e.target.classList.contains("view-polish") ? e.target : e.target.closest(".view-polish");
        const id = button.dataset.polishId;

        fetch(`/api/polishes/${id}/`)
        .then(res => res.json())
        .then(polish => {
            if (polish.success === false) {
                showPolishAlert("danger", polish.message);
                return;
            }
            document.getElementById("view_polish_name").textContent = polish.polish_name;
            document.getElementById("view_polish_created_at").textContent = polish.created_at;
            document.getElementById("view_polish_updated_at").textContent = polish.updated_at;
            viewPolishModal.show();
        })
        .catch(error => {
            showPolishAlert("danger", "Error loading polish details.");
        });
    }

    // -------- EDIT POLISH --------
    if(e.target.classList.contains("edit-polish") || e.target.closest(".edit-polish")){
        const button = e.target.classList.contains("edit-polish") ? e.target : e.target.closest(".edit-polish");
        const id = button.dataset.polishId;

        fetch(`/api/polishes/${id}/`)
        .then(res => res.json())
        .then(polish => {
            if (polish.success === false) {
                showPolishAlert("danger", polish.message);
                return;
            }
            document.getElementById("edit_polish_id").value = polish.id;
            document.getElementById("edit_polish_name").value = polish.polish_name;
            editPolishModal.show();
        })
        .catch(error => {
            showPolishAlert("danger", "Error loading polish for editing.");
        });
    }

    // -------- DELETE POLISH --------
    if(e.target.classList.contains("delete-polish") || e.target.closest(".delete-polish")){
        const button = e.target.classList.contains("delete-polish") ? e.target : e.target.closest(".delete-polish");
        deletePolishId = button.dataset.polishId;
        
        fetch(`/api/polishes/${deletePolishId}/`)
        .then(res => res.json())
        .then(polish => {
            if (polish.success === false) {
                showPolishAlert("danger", polish.message);
                return;
            }
            document.getElementById("delete_polish_name").textContent = polish.polish_name;
            deletePolishModal.show();
        })
        .catch(error => {
            showPolishAlert("danger", "Error loading polish for deletion.");
        });
    }
});

// ===================== CREATE POLISH =====================
document.getElementById("saveCreatePolish").onclick = function(){
    const polishData = {
        polish_name: document.getElementById("create_polish_name").value.trim()
    };

    // Client-side validation
    if (!polishData.polish_name) {
        showPolishAlert("danger", "Polish name is required.");
        return;
    }

    fetch('/api/polishes/create/',{
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value
        },
        body:JSON.stringify(polishData)
    })
    .then(res=>res.json())
    .then(r=>{
        if(r.success){
            createPolishModal.hide();
            document.getElementById("createPolishForm").reset();
            showPolishAlert("success", r.message);
            
            // Add new row to table
            const tableBody = document.querySelector('#polishTable tbody');
            const newRow = document.createElement('tr');
            newRow.id = `polish-row-${r.polish.id}`;
            newRow.innerHTML = `
                <td>${r.polish.polish_name}</td>
                <td>${r.polish.created_at}</td>
                <td>${r.polish.updated_at}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-info view-polish" data-polish-id="${r.polish.id}">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary edit-polish" data-polish-id="${r.polish.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-polish" data-polish-id="${r.polish.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            `;
            // Remove empty message if it exists
            if (tableBody.querySelector('tr:first-child td[colspan]')) {
                tableBody.innerHTML = '';
            }
            tableBody.appendChild(newRow);
        }else{
            showPolishAlert("danger", r.message);
        }
    })
    .catch(error => {
        showPolishAlert("danger", "Error creating polish.");
    });
};

// ===================== UPDATE POLISH =====================
document.getElementById("saveEditPolish").onclick = function(){
    const id = document.getElementById("edit_polish_id").value;
    const polishData = {
        polish_name: document.getElementById("edit_polish_name").value.trim()
    };

    // Client-side validation
    if (!polishData.polish_name) {
        showPolishAlert("danger", "Polish name is required.");
        return;
    }

    fetch(`/api/polishes/${id}/update/`,{
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value
        },
        body:JSON.stringify(polishData)
    })
    .then(res=>res.json())
    .then(r=>{
        if(r.success){
            editPolishModal.hide();
            showPolishAlert("success", r.message);
            
            // Update row in table
            const row = document.getElementById(`polish-row-${id}`);
            row.innerHTML = `
                <td>${r.polish.polish_name}</td>
                <td>${r.polish.created_at}</td>
                <td>${r.polish.updated_at}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-info view-polish" data-polish-id="${r.polish.id}">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary edit-polish" data-polish-id="${r.polish.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-polish" data-polish-id="${r.polish.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            `;
        }else{
            showPolishAlert("danger", r.message);
        }
    })
    .catch(error => {
        showPolishAlert("danger", "Error updating polish.");
    });
};

// ===================== DELETE POLISH =====================
document.getElementById("confirmDeletePolish").onclick = function(){
    fetch(`/api/polishes/${deletePolishId}/delete/`,{
        method:"POST",
        headers:{
            "X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value
        }
    })
    .then(res=>res.json())
    .then(r=>{
        if(r.success){
            deletePolishModal.hide();
            document.getElementById(`polish-row-${deletePolishId}`).remove();
            showPolishAlert("success", r.message);
            
            // Check if table is empty
            const tableBody = document.querySelector('#polishTable tbody');
            if (tableBody.children.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No polishes found. Click "Add Polish" to create one.</td></tr>';
            }
        }else{
            showPolishAlert("danger", r.message);
        }
    })
    .catch(error => {
        showPolishAlert("danger", "Error deleting polish.");
    });
};

// ===================== SAFETY CLEANUP =====================
document.addEventListener("hidden.bs.modal", function(){
    document.body.classList.remove("modal-open");
    document.querySelectorAll(".modal-backdrop").forEach(b=>b.remove());
});
</script>
{% endblock %}